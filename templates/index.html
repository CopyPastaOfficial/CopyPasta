<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CopyPasta</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='dist/css/bootstrap.min.css') }}">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand">CopyPasta</a>
            <div class="collapse navbar-collapse" id="navbarText">
                <ul class="navbar-nav mr-auto">
                  <li class="nav-item active">
                    
                </li>
                </ul>
              </div>
        </div>
    </nav>
    <div class="alert alert-success" role="alert" id="notification" style="display: none;">
        This is a success alert
    </div>
    <div class="container mt-3">
        <div class="row">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-header">
                        Configuration
                    </div>
                    <div class="card-body">
                        <h5>Bienvenue dans CopyPasta</h5>
                        <h6>Scannez ce QR Code dans l'application :</h6>
                        <img class="mb-3" src="../static/qr.jpeg" width="125px" height="auto" />
                        <h6>Nom : {{hostname}}</h6>
                        <h6>IP : {{ip}}</h6>
                        <hr>
                        <h6>
                            {%if tab!=True%}
                            <div class="form-check form-switch">                                
                                <label class="form-check-label" for="flexSwitchCheckDefault">Ouvrir un nouvel onglet quand quand un scan arrive</label>
                                <input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault" onclick="change_tab_settings()"/>
                            </div>
                            {%else%}
                                <div class="form-check form-switch">
                                    <label class="form-check-label" for="flexSwitchCheckChecked">Ouvrir un nouvel onglet quand quand un scan arrive</label>
                                    <input class="form-check-input" type="checkbox" id="flexSwitchCheckChecked" onclick="change_tab_settings()" checked/>
                                </div>
                            {%endif%}
                                                    
                        </h6>
                    </div>
                </div>

            </div>
            
            <div class="col-md">
                <h1>Derniers fichiers et textes envoyés :</h1>
                <hr/>
                <a class="btn btn-primary mb-3" onclick="request_and_notify('Historique des scans supprimé !','/process/[DEL HISTORY]')">Supprimer tout l'historique</a>

                <table class="table table-striped text-center" id="history_table">
                    <thead>
                        <tr class="bg-primary" style="color: white;">
                            <th scope="col">Date</th>
                            <th scope="col">Content/file name</th>
                            <th scope="col">Action</th>
                        </tr>
                    </thead>
                    <tbody id="history_table_body">

                    </tbody>
                </table>



            </div>
        </div>
    </div>
    <script src="{{ url_for('static', filename='dist/js/bootstrap.bundle.min.js') }}"></script>
    {% with messages = get_flashed_messages() %} {% if messages %}
    <script>
        var messages = {
            {
                messages | safe
            }
        };
        alert(messages[messages.length - 1]);
    </script>
    {% endif %} {% endwith %}

    <style>
        .btn-primary {
            color: white;
        }
        
        body {
            background: #333 url(https://wallpaperaccess.com/full/1236480.jpg) repeat;
        }

        

    </style>
    
    <script>


        function fill_history_tab(){

            var xmlHttp = new XMLHttpRequest();

            xmlHttp.open( "GET", "http://127.0.0.1:21987/api/get_history", false ); // false for synchronous request
            xmlHttp.send( null );
            var r = xmlHttp.responseText;
            console.log(r);
            if(r == "{\"history\" : []}"){
                document.getElementById("history_table_body").innerHTML = "";
            }else{
                var json = JSON.parse(r).history;
            
                var elements = [];

                for (let i = 0; i < json.length; i++) {
                    var obj = json[i];
                    var tab_element = "";

                    var images_ext = ["jpeg","jpg","png","ico","gif"];
                    
                    //images
                    if(images_ext.includes(obj.file_type)){
                        tab_element = "<tr>"+"<td>"+obj.date+"</td>"+"<td><img src=\""+obj.path+"\" height=\"auto\" width=\"100px\"></td>"+"<td>"+"<a href=\"/image_preview?path="+obj.path+"\" class=\"btn btn-primary\">Ouvrir</a>"+"<a class=\"btn btn-danger\" onclick=\"request_and_notify('Image supprimée !','/process/[DELETE_FILE_FROM_HIST]?file_id="+i+"')\">Supprimer</a>"+"</td>"+"</tr>";
                    }else{
                        //text scans
                        if(obj.file_type == "text_scan"){
                            tab_element = "<tr>    <td>"+obj.date+"</td>    <td>"+ obj.text.substring(0,12)+"...</td>    <td>        <a class=\"btn btn-primary\" onclick=\"request_and_notify('Scan copié !','/process/[COPY_SCAN_FROM_HIST]?scan_id="+i+"')\">Copier</a>        <a href=\"/hist/"+i+"\" class=\"btn btn-primary\">Ouvrir</a>        <a class=\"btn btn-danger\" onclick=\"request_and_notify('Scan supprimé !','/process/[DELETE_SCAN_FROM_HIST]?scan_id="+i+"')\">Supprimer</a>    </td></tr>";
                        
                        //all other stuff (will be updated)
                        }else{
                            tab_element = "<tr><td>"+obj.date+"</td><td>"+obj.file_name+"</td><td><a href=\"/process/[OPEN FILES EXPLORER]\" class=\"btn btn-primary\">Ouvrir dans l'explorateur de fichiers</a><br><a href=\"/process/[OPEN FILE]?file_path="+obj.path+"\" class=\"btn btn-primary\" style=\"margin-top:10px;\">Ouvrir</a><a class=\"btn btn-danger\" style=\"margin-top:10px;margin-left:10px;\" onclick=\"request_and_notify('Fichier supprimé !','/process/[DELETE_FILE_FROM_HIST]?file_id="+i+"')\">Supprimer</a></td></tr>";
                        }
                    }

                


                    elements.push(tab_element);


                }
                var all = "";


                for(let i = 0;i<elements.length;i++){
                    all = all + elements[i];
                }

                if(document.getElementById("history_table_body").innerHTML != all){
                    notify("Nouvel élément reçu !");
                    console.log(all);
                    console.log(document.getElementById("history_table_body").innerHTML);
                    document.getElementById("history_table_body").innerHTML = all;
                }
                


            }


            setTimeout(fill_history_tab,1500);
        }





    function change_tab_settings(){
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "http://127.0.0.1:21987/process/[CHANGE TAB SETTINGS]", false ); // false for synchronous request
        xmlHttp.send( null );
        console.log("tab settings changed")
    }
    

    function notify(text){
        if (document.getElementById("notification").style.display == "none"){
            document.getElementById("notification").innerText = text;
            document.getElementById("notification").style.display = "block";
        }else{
            document.getElementById("notification").style.display = "none";
        }
        
        setTimeout(delete_notification,3000);
    }

    function delete_notification(){
        document.getElementById("notification").style.display = "none";

    }

    function request_and_notify(text,url){
        if (document.getElementById("notification").style.display == "none"){
            document.getElementById("notification").innerText = text;
            document.getElementById("notification").style.display = "block";
        }else{
            document.getElementById("notification").style.display = "none";
        }

        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", url, false ); // false for synchronous request
        xmlHttp.send( null );
        
        setTimeout(delete_notification,3000);
    }




    window.onload = fill_history_tab();


</script>
    
    
</body>

</html>